<!DOCTYPE html>
<html>
    <head>
        <title>Samfundet ticketbuyer</title>
        <style>
            form {
                display: flex;
                flex-direction: column;
            }
            html {
                background: #a03033;
            }

            body {
                width: 50%;
                margin: auto;
                font-family: sans-serif;
                width: 50%;
                background: white;
                height: 100vh;
                margin-top: -21px;
                padding: 0 50px;
                box-shadow: 0 2px 5px 0 rgba(0,0,0,0.16), 0 2px 10px 0 rgba(0,0,0,0.12);
            }

            #top-title {
                text-align: center;
                padding-top: 40px;
            }

            input {
                border: none;
                border-bottom: 1px solid darkgrey;
                height: 20px;
                margin: 5px 0;
            }

            label {
                margin: 5px 0 0 0;
            }

            select {
                margin: 5px 0;
            }

            #submit {
                border: 1px solid darkgrey;
                border-radius: 3px;
                height: 30px;
            }

            #submit:active {
                background: darkgrey;
                color: white;
                border: 1px solid white;
            }

        </style>
        <meta charset="utf-8" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
    <body>
        <h1 id="top-title">Samfundet autobuyer</h1>
        <div class="container">
            <form method="post" action="/get_site">
                <label for="email_or_membercard" title="Hvis du ikke krysser av på checkboksen under, skriver du inn eposten din her. Hvis du heller vil ha billetten billettløst, skriv inn medlemsnummeret ditt her, og kryss av på checkboksen under.">Email/medlemsnummer   ?</label>
                <input type="text" name="email_or_membercard" id="email_or_membercard" required />
                <label for="member_card" title="Hvis du skrev inn medlemsnummere ditt over, kryss av her.">Medlemskort   ?</label>
                <input type="checkbox" name="member_card" id="member_card" />
                <label for="num_members" title="Hvor mange medlemsbilletter du vil kjøpe">Hvor mange medlemmer   ?</label>
                <input type="number" name="num_members" id="num_members" value="0" min="0" required />
                <label for="num_non_members" title="Hvor mange ikke-medlemsbilletter du har lyst til å kjøpe.">Hvor mange ikke-medlem   ?</label>
                <input type="number" name="num_non_members" id="num_non_members" value="0" min="0" required />
                <label for="card_number" title="Kortnummeret på bankkortet ditt">Kortnummer   ?</label>
                <input type="text" name="card_number" id="card_number" minlength="16" maxlength="16" required />
                <label for="expiration_month" title="Utløpsmåned på bankkortet ditt">Utløpsmnd   ?</label>
                <input type="number" min="1" max="12" name="expiration_month" id="expiration_month" required />
                <label for="expiration_year" title="Utløpsåret på bankkortet ditt">Utløpsår   ?</label>
                <input type="number" name="expiration_year" id="expiration_year" min="18" required />
                <label for="cvc2" title="CVC2 nummeret på bankkortet ditt">CVC2   ?</label>
                <input type="text" name="cvc2" id="cvc2" maxlength="3" required />
                <label for="url" title="Paste event-url'en til det eventet du vil kjøpe her, eller velg fra dropdownmenyen under.">event-url   ?</label>
                <input type="text" name="url" id="url" autocomplete="off" />
                eller
                <select id="events" name="select_option">
                    <option value="none">Velg event</option>
                </select>
                <label for="try" title="Hvis du vil at siden skal automatisk skal prøve å kjøpe billett uendelig til du lukker vinduet, uten å tenke over å trykke kjøp igjen, kryss av her.">Prøv uendelig til du lukker vinduet   ?</label>
                <input type="checkbox" name="try_infinite" id="try" checked="true" />
                <input type="submit" id="submit" value="Kjøp" />
            </form>
            <h3>Legal disclaimer: The developer takes no responsibility in any lost money or faulty transactions. Use at your own risk.</h3>
        </div>
        <script>
        var parseQueryString = function() {

            var str = window.location.search;
            var objURL = {};

            str.replace(
                new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
                function( $0, $1, $2, $3 ){
                    objURL[ $1 ] = $3;
                }
            );
            return objURL;
        };

        var email;
        var num_members;
        var num_non_members;
        var member_card;
        var card_number;
        var expiration_month;
        var expiration_year;
        var cvc2;
        var params = parseQueryString();
        var times_tried = 1;

        /*$("#email_or_membercard").val(params.email_member);
        $("#member_card").prop("checked", params.member_card == "true");
        $("#num_members").val(params.num_members);
        $("#num_non_members").val(params.num_non_members);
        $("#card_number").val(params.card_number);
        $("#expiration_month").val(params.expiration_month);
        $("#expiration_year").val(params.expiration_year);
        $("#cvc2").val(params.cvc2);
        $("#url").val(params.url);*/
        if(params.error == true || params.error == "true") {
            $(".container").prepend("<h3>Not opened or sold out</h3>");
        }
        if(window.location.hash == "#try_again") {
            $("#try").prop("checked", true);
            if($("#tried_num").length == 0) {
                $(".container").prepend("<h4 id='tried_num'>Tried " + times_tried + " times</h4>");
            } else {
                $("#tried_num").text("Tried " + times_tried + " times");
            }
            times_tried += 1;
            if($("#tried").length == 0) {
                $(".container").prepend("<h2 id='tried'>Trying again</h2>");
            } else {
                $("#tried").text("Trying again");
            }
            setTimeout(function() {
                $("#submit").trigger("click");
            }, 1000);
        }

        $().ready(function() {
            for(var i = 0; i < elements.length; i++) {
                $("#events").append("<option value='" + elements[i].link + "'>" + elements[i].name + "</option>");
            }
        });

        $("form").on("submit", function(e) {
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "/get_site",
                data: {
                    url: $("#url").val(),
                    select_option: $("#events").val(),
                },
                success: function(response) {
                    if(response == "failed") {
                        if($("#try").prop("checked")) {
                            if($("#tried_num").length == 0) {
                                $(".container").prepend("<h4 id='tried_num'>Tried " + times_tried + " times</h4>");
                            } else {
                                $("#tried_num").text("Tried " + times_tried + " times");
                            }
                            times_tried += 1;
                            if($("#tried").length == 0) {
                                $(".container").prepend("<h2 id='tried'>Trying again</h2>");
                            } else {
                                $("#tried").text("Trying again");
                            }
                            setTimeout(function() {
                                $("#submit").trigger("click");
                            }, 1000);
                        } else {
                            $(".container").prepend("<h2 id='tried'>Failed, please try again</h2>");
                        }
                    } else {
                        email = $("#email_or_membercard").val();
                        num_members = $("#num_members").val();
                        num_non_members = $("#num_non_members").val();
                        member_card = $("#member_card").prop("checked");
                        card_number = $("#card_number").val();
                        expiration_month = $("#expiration_month").val();
                        expiration_year = $("#expiration_year").val();
                        cvc2 = $("#cvc2").val();

                        var res2 = response;
                        $("body").empty();
                        $("body").append(res2.substring(res2.indexOf("body") + 6, res2.indexOf("/body") - 3));
                        $("head").append(res2.substring(res2.indexOf("head") + 6, res2.indexOf("/head") - 3));
                    }
                },
            })
        });
        </script>
    </body>
</html>

<!DOCTYPE html>
<html>
    <head>
        <title>Samfundet ticketbuyer</title>
        <style>
            form {
                display: flex;
                flex-direction: column;
            }
        </style>
        <meta charset="utf-8" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
    <body>
        <form method="post" action="/get_site">
            <label for="email_or_membercard">Medlemskortnummer eller email</label>
            <input type="text" name="email_or_membercard" id="email_or_membercard" />
            <label for="member_card">Medlemskort?</label>
            <input type="checkbox" name="member_card" id="member_card" />
            <label for="num_members"># medlemmer</label>
            <input type="number" name="num_members" id="num_members" />
            <label for="num_non_members"># ikke medlemmer</label>
            <input type="number" name="num_non_members" id="num_non_members" />
            <label for="card_number">Kortnummer</label>
            <input type="text" name="card_number" id="card_number" minlength="16" maxlength="16"/>
            <label for="expiration_month">mnd</label>
            <input type="number" min="1" max="12" name="expiration_month" id="expiration_month" />
            <label for="expiration_year">Ã¥r</label>
            <input type="number" name="expiration_year" id="expiration_year" min="18" />
            <label for="cvc2">cvc2</label>
            <input type="text" name="cvc2" id="cvc2" maxlength="3" />
            <label for="url">url</label>
            <input type="text" name="url" id="url" autocomplete="off" />
            or
            <select id="events" name="select_option">
                <option value="none">Choose event</option>
            </select>
            <label for="try">Try till close tab</label>
            <input type="checkbox" name="try_infinite" id="try" />
            <input type="submit" id="submit" />
        </form>
        <script>
        var parseQueryString = function() {

            var str = window.location.search;
            var objURL = {};

            str.replace(
                new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
                function( $0, $1, $2, $3 ){
                    objURL[ $1 ] = $3;
                }
            );
            return objURL;
        };

        var email;
        var num_members;
        var num_non_members;
        var member_card;
        var card_number;
        var expiration_month;
        var expiration_year;
        var cvc2;
        var params = parseQueryString();

        $("#email_or_membercard").val(params.email_member);
        $("#member_card").prop("checked", params.member_card == "true");
        $("#num_members").val(params.num_members);
        $("#num_non_members").val(params.num_non_members);
        $("#card_number").val(params.card_number);
        $("#expiration_month").val(params.expiration_month);
        $("#expiration_year").val(params.expiration_year);
        $("#cvc2").val(params.cvc2);
        $("#url").val(params.url);
        if(params.error == true || params.error == "true") {
            $("body").prepend("<h3>Not opened or sold out</h3>");
        }
        if(window.location.hash == "#try_again") {
            $("#try").prop("checked", true);
            $("body").prepend("<h1>Trying again</h1>");
            setTimeout(function() {
                $("#submit").trigger("click");
            }, 1000);
        }

        $().ready(function() {
            for(var i = 0; i < elements.length; i++) {
                $("#events").append("<option value='" + elements[i].link + "'>" + elements[i].name + "</option>");
            }
        });

        $("form").on("submit", function(e) {
            console.log(e, $("#url").val());
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "/get_site",
                data: {
                    url: $("#url").val(),
                    select_option: $("#events").val(),
                },
                success: function(response) {
                    email = $("#email_or_membercard").val();
                    num_members = $("#num_members").val();
                    num_non_members = $("#num_non_members").val();
                    member_card = $("#member_card").prop("checked");
                    card_number = $("#card_number").val();
                    expiration_month = $("#expiration_month").val();
                    expiration_year = $("#expiration_year").val();
                    cvc2 = $("#cvc2").val();

                    var res2 = response;
                    $("body").empty();
                    $("body").append(res2.substring(res2.indexOf("body") + 6, res2.indexOf("/body") - 3));
                    $("head").append(res2.substring(res2.indexOf("head") + 6, res2.indexOf("/head") - 3));

                },
            })
        });
        </script>
    </body>
</html>
